#!/bin/bash
#
# dedistracter-cron-generator
#
# This script generates crontab entries based on environment variables
# and installs them into the system crontab.
#
# Environment Variables:
#   BLOCK_HOUR       - Hour to block (0-23, default: 2)
#   BLOCK_MINUTE     - Minute to block (0-59, default: 0)
#   UNBLOCK_HOUR     - Hour to unblock (0-23, default: 20)
#   UNBLOCK_MINUTE   - Minute to unblock (0-59, default: 0)
#

set -e

# Configuration with defaults
BLOCK_HOUR="${BLOCK_HOUR:-2}"
BLOCK_MINUTE="${BLOCK_MINUTE:-0}"
UNBLOCK_HOUR="${UNBLOCK_HOUR:-20}"
UNBLOCK_MINUTE="${UNBLOCK_MINUTE:-0}"

# Validate inputs
for var in BLOCK_HOUR BLOCK_MINUTE UNBLOCK_HOUR UNBLOCK_MINUTE; do
    if ! [[ ${!var} =~ ^[0-9]+$ ]] || [[ ${!var} -lt 0 ]] || [[ ${!var} -gt 59 ]]; then
        if [[ $var == *"HOUR" && ${!var} -gt 23 ]]; then
            echo "Error: $var must be between 0 and 59 (or 0-23 for hours)" >&2
            exit 1
        fi
    fi
done

# Generate crontab entries
CRON_ENTRIES="# Dedistracter - Pi Hole distraction blocking schedule
# Generated by dedistracter-cron-generator
# Edit via: BLOCK_HOUR=2 BLOCK_MINUTE=0 UNBLOCK_HOUR=20 UNBLOCK_MINUTE=0 dedistracter-cron-generator

${BLOCK_MINUTE} ${BLOCK_HOUR} * * * /bin/bash -lc '/opt/dedistracter/block-distractions.sh'
${UNBLOCK_MINUTE} ${UNBLOCK_HOUR} * * * /bin/bash -lc '/opt/dedistracter/unblock-distractions.sh'"

echo "Generated crontab entries:"
echo "$CRON_ENTRIES"
